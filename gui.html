<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel='stylesheet' type='text/css' href='styles.css'>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.7.3/nipplejs.js"></script>

  <script type="text/javascript" type="text/javascript">

	var recentIDs = [];
	var searching = false;
	var threshold = 0.10;

// ros status listener
    var ros = new ROSLIB.Ros({
      url: 'ws://localhost:9090'
    });

	// logs all available ros topics
	function getTopics() {
	    var topicsClient = new ROSLIB.Service({
	    ros : ros,
	    name : '/rosapi/topics',
	    serviceType : 'rosapi/Topics'
	    //serviceType : 'rosapi/TopicType'
	    });

	    var request = new ROSLIB.ServiceRequest();
	    //var request = new ROSLIB.ServiceRequest({topic: '/darknet_ros/bounding_boxes'});

	    topicsClient.callService(request, function(result) {
	    console.log("Getting topics...");
	    console.log(result.topics);
	    console.log('Topic Types: ', result.types); //topic types 
	    });
	};

    ros.on('error', function (error) {
      document.getElementById("status").innerHTML = "Error";
    });

    ros.on('connection', function () {
      document.getElementById("status").innerHTML = "Connected";
      console.log('successfully connected to websocket server');
    });

    ros.on('close', function () {
      document.getElementById("status").innerHTML = "Closed";
    });


// search status listener
  var search_listener = new ROSLIB.Topic({
    ros : ros,
    name : '/search_msg',
    messageType : 'std_msgs/String'
  });

  search_listener.subscribe(function(m) {
    document.getElementById("search_status").innerHTML = m.data;
  });


// identifications listener
  var items_listener = new ROSLIB.Topic({
    ros : ros,
    name : '/darknet_ros/bounding_boxes',
    messageType : 'darknet_ros_msgs/BoundingBoxes'
  });

  items_listener.subscribe(function(message) {
	if (searching) {
		//console.log(typeof message.data);
		//console.log(message);
		if (message.bounding_boxes[0].probability > threshold) {  // the threshold variable percentage for detection confidence
			recentIDs.push(" " + message.bounding_boxes[0].Class);
		}

		document.getElementById("items_msg").innerHTML = recentIDs;
		listener.unsubscribe();
	}
  });


// image listener
  var image_listener = new ROSLIB.Topic({
    ros : ros,
    name : '/darknet_ros/detection_image',
    messageType : 'sensor_msgs/Image'
  });

  items_listener.subscribe(function(message) {
	if (searching) {
		console.log(message);
		
		document.getElementById("testimg");
		img.setAttribute('src', message);
		listener.unsubscribe();
	}
  });



// troubleshooting listener
	var listener = new ROSLIB.Topic({
		ros : ros,
		name : '/listener',
		messageType : 'std_msgs/String'
	});

	listener.subscribe(function(message) {
	  	console.log('Received message on ' + listener.name + ': ' + message.data);
		img = document.getElementById("txt_msg").innerHTML = message.data;
		listener.unsubscribe();
	});



// Publishers
// search button publisher
  var search_cmd_listener = new ROSLIB.Topic({
    ros : ros,
    name : '/cmd_srch',
    messageType : 'std_msgs/String'  // todo update if necessary
  });

  start_search = function() {
	var search = new ROSLIB.Message({
		// todo add proper message to start search
	});
	search_cmd_listener.publish(search);
  }

  search_cmd_listener.subscribe(function(m) {
    document.getElementById("search_button").innerHTML = m.data;
    move(1, 0);
  });


// reset variables for new search
	function startSearch() {
		if (!searching) {
			//recentIDs.length = 0;
			searching = true;
		}
	};


// clear the list of identified items
	function clearItems() {
		recentIDs.length = 0;
		document.getElementById("items_msg").innerHTML = recentIDs;
	};

// Immediately hault everything
	function stop() {
		// stop navigation
		// stop receiving new object identifications
		searching = false;
	};

  </script>
</head>

<body>
  <h1>RoomSense Robot</h1>
  <button onclick="startSearch()">Search Room<span id="search_button"></span></button>
  <button onclick="clearItems()">Clear Items<span id="clear_items"></span></button>
  </br>
  <button style="background-color:#8e3858;" onclick="stop()">Stop<span id="stop_button"></span></button>
  <p>Ros connection status: <span id="status"></span></p>
  <p>Search status: <span id="search_status"></span></p>
  <p>Last items identified: <span id="items_msg"> </span></p>
  </br>
  
  <img src="" alt="", id="testimg">
<!-- 
  <div id="zone_joystick" style="position: relative;"></div>

//-->

<!--  sanity check to see that JS sees the same topics as ROS in the command line
  <button onclick="getTopics()">Get Topics<span id="search_button"></span></button>
  <p>Text Messages: <span id="txt_msg"></span></p>

//-->
</body>

</html>
